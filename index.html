<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>E-casso Lab</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:black;
      overflow:hidden;
    }
    .screen{
      position:fixed;
      inset:0;
      display:none;
    }
    .screen.active{display:block}

    #idle{z-index:1}
    #loading{z-index:2}
    #cosmos{z-index:3}
    #final{z-index:4}

    #scan-overlay{
      position:absolute;
      left:30%;
      top:72%;
      width:36%;
      height:18%;
      overflow:hidden;
      pointer-events:none;
    }
    #scan-overlay video{
      width:100%;
      height:100%;
      object-fit:cover;
      transform:scaleX(-1);
    }
    .scan-line{
      position:absolute;
      inset:0;
      background:linear-gradient(
        to bottom,
        transparent,
        rgba(255,255,255,.6),
        transparent
      );
      animation:scan 2.5s linear infinite;
    }
    @keyframes scan{
      from{transform:translateY(-100%)}
      to{transform:translateY(100%)}
    }

    #debug{
      position:fixed;
      bottom:8px;
      left:8px;
      color:#888;
      font-size:12px;
      z-index:999;
    }
  </style>
</head>

<body>

<!-- IDLE -->
<div id="idle" class="screen active">
  <div id="scan-overlay">
    <video id="camera" autoplay muted playsinline></video>
    <div class="scan-line"></div>
  </div>
</div>

<!-- LOADING -->
<div id="loading" class="screen"></div>

<!-- COSMOS -->
<div id="cosmos" class="screen"></div>

<!-- FINAL -->
<div id="final" class="screen"></div>

<div id="debug">state: —</div>

<script type="module">
/* =========================================================
   Firebase
========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyAoH3O3t8SYirmcCPVDG19bVC_Nh2VrAQc",
  authDomain: "e-casso-lab.firebaseapp.com",
  databaseURL: "https://e-casso-lab-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "e-casso-lab"
});
const db = getDatabase(app);

const STATES={
  IDLE:"IDLE",
  LOADING:"LOADING",
  COSMOS:"COSMOS",
  FINAL:"FINAL"
};

/* =========================================================
   Camera（純顯示用）
========================================================= */
const video=document.getElementById("camera");
let camStream=null;

function startCamera(){
  if(camStream) return;
  navigator.mediaDevices.getUserMedia({video:true})
    .then(s=>{
      camStream=s;
      video.srcObject=s;
    });
}
function stopCamera(){
  if(!camStream) return;
  camStream.getTracks().forEach(t=>t.stop());
  camStream=null;
  video.srcObject=null;
}

/* =========================================================
   MediaPipe Hands（只給 COSMOS）
========================================================= */
let hands=null;
let mpCamera=null;
let handActive=false;

function initHands(videoEl){
  stopHands(); // ✅ 保證乾淨

  hands=new Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });
  hands.setOptions({
    maxNumHands:1,
    modelComplexity:1,
    minDetectionConfidence:.7,
    minTrackingConfidence:.7
  });

  hands.onResults(res=>{
    handActive=!!res.multiHandLandmarks?.length;
  });

  mpCamera=new Camera(videoEl,{
    onFrame:async()=>{ await hands.send({image:videoEl}); },
    width:640,
    height:480
  });

  mpCamera.start();
}

function stopHands(){
  handActive=false;
  if(mpCamera){
    try{mpCamera.stop();}catch{}
    mpCamera=null;
  }
  if(hands){
    try{hands.close();}catch{}
    hands=null;
  }
}

/* =========================================================
   COSMOS（簡化示意）
========================================================= */
let scene=null,renderer=null,camera3D=null,rafId=null;

function initCosmos(){
  if(scene) return;
  scene=new THREE.Scene();
  camera3D=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,1000);
  camera3D.position.z=300;

  renderer=new THREE.WebGLRenderer({alpha:true});
  renderer.setSize(innerWidth,innerHeight);
  document.getElementById("cosmos").appendChild(renderer.domElement);

  const geo=new THREE.BufferGeometry();
  geo.setAttribute("position",new THREE.BufferAttribute(
    new Float32Array(3000).map(()=> (Math.random()-.5)*400 ),3
  ));
  const mat=new THREE.PointsMaterial({color:0x66ffff,size:1});
  const pts=new THREE.Points(geo,mat);
  scene.add(pts);

  function loop(){
    renderer.render(scene,camera3D);
    rafId=requestAnimationFrame(loop);
  }
  loop();
}

function stopCosmos(){
  if(rafId) cancelAnimationFrame(rafId);
  rafId=null;
}

/* =========================================================
   Screen switch
========================================================= */
function switchScreen(state){
  document.querySelectorAll(".screen")
    .forEach(s=>s.classList.remove("active"));
  document.getElementById(state.toLowerCase()).classList.add("active");
}

/* =========================================================
   State listener（重點）
========================================================= */
onValue(ref(db,"runtime/state"),snap=>{
  const state=snap.val();
  document.getElementById("debug").textContent=`state: ${state}`;
  if(!state) return;

  switchScreen(state);

  if(state===STATES.IDLE){
    stopHands();        // ❌ 不准 MediaPipe
    startCamera();      // ✅ 只有掃描畫面
    stopCosmos();
  }

  if(state===STATES.LOADING){
    stopHands();
    stopCamera();
    stopCosmos();
  }

  if(state===STATES.COSMOS){
    startCamera();
    initHands(video);   // ✅ 只在 COSMOS
    initCosmos();
  }

  if(state===STATES.FINAL){
    stopHands();
    stopCamera();
    stopCosmos();
  }
});

/* =========================================================
   Control（手機端）
========================================================= */
onValue(ref(db,"control"),async snap=>{
  const cmd=snap.val();
  if(!cmd?.action) return;

  if(cmd.action==="RESET"){
    await set(ref(db,"runtime/state"),STATES.IDLE);
  }
  if(cmd.action==="START"){
    await set(ref(db,"runtime/state"),STATES.LOADING);
    setTimeout(()=>{
      set(ref(db,"runtime/state"),STATES.COSMOS);
    },1200);
  }
  if(cmd.action==="FINAL"){
    await set(ref(db,"runtime/state"),STATES.FINAL);
  }
});
</script>
</body>
</html>
